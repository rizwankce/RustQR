name: Fast Benchmark

on:
  workflow_dispatch:
    inputs:
      platform:
        description: 'Target platform'
        required: false
        default: 'macos'
        type: choice
        options:
          - macos
          - linux
          - windows
          - all
      bench_limit:
        description: 'Number of images per category (0 = all)'
        required: false
        default: '25'
        type: string
      category:
        description: 'Optional category filter (e.g. rotations, blurred, high_version)'
        required: false
        default: ''
        type: string
      run_reading_rate:
        description: 'Run reading rate benchmark'
        required: false
        default: true
        type: boolean
      run_criterion_smoke:
        description: 'Run Criterion smoke benchmark'
        required: false
        default: false
        type: boolean

env:
  CARGO_TERM_COLOR: always

jobs:
  benchmark-linux:
    name: Fast Benchmark on linux
    runs-on: ubuntu-latest
    if: ${{ inputs.platform == 'all' || inputs.platform == 'linux' }}
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-fast-bench-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-fast-bench-
            ${{ runner.os }}-cargo-bench-
            ${{ runner.os }}-cargo-

      - name: Build release (with tools)
        run: cargo build --release --features tools

      - name: Run reading rate benchmark (fast)
        if: ${{ inputs.run_reading_rate }}
        env:
          QR_BENCH_LIMIT: ${{ inputs.bench_limit }}
        run: |
          echo "## Fast Reading Rate - linux" >> $GITHUB_STEP_SUMMARY
          echo "Limit: \`${{ inputs.bench_limit }}\`" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ inputs.category }}" ]; then
            echo "Category: \`${{ inputs.category }}\`" >> $GITHUB_STEP_SUMMARY
            # Run each category separately
            for CAT in $(echo "${{ inputs.category }}" | tr ',' '\n'); do
              echo "Running: $CAT" >> $GITHUB_STEP_SUMMARY
              cargo run --features tools --bin qrtool --release -- \
                reading-rate \
                --non-interactive \
                --category "$CAT" \
                --artifact-json "reading_rate_${CAT}.json" \
                2>&1 | tee "reading_rate_${CAT}.txt"
              echo "---" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "Category: all" >> $GITHUB_STEP_SUMMARY
            cargo run --features tools --bin qrtool --release -- \
              reading-rate \
              --non-interactive \
              --artifact-json "reading_rate_linux.json" \
              2>&1 | tee "reading_rate_linux.txt"
            cat "reading_rate_linux.txt" >> $GITHUB_STEP_SUMMARY
          fi
          echo '```' >> $GITHUB_STEP_SUMMARY
        shell: bash

      - name: Run Criterion smoke benchmark
        if: ${{ inputs.run_criterion_smoke }}
        env:
          QR_SMOKE: "1"
        run: |
          echo "## Criterion Smoke - linux" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cargo bench --features tools --bench real_qr_images 2>&1 | tee "criterion_smoke_linux.txt"
          cat "criterion_smoke_linux.txt" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        shell: bash

      - name: Upload fast benchmark artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fast-benchmark-results-linux
          path: |
            reading_rate_*.txt
            reading_rate_*.json
            criterion_smoke_*.txt
          retention-days: 14

  benchmark-macos:
    name: Fast Benchmark on macos
    runs-on: macos-latest
    if: ${{ inputs.platform == 'all' || inputs.platform == 'macos' }}
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-fast-bench-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-fast-bench-
            ${{ runner.os }}-cargo-bench-
            ${{ runner.os }}-cargo-

      - name: Build release (with tools)
        run: cargo build --release --features tools

      - name: Run reading rate benchmark (fast)
        if: ${{ inputs.run_reading_rate }}
        env:
          QR_BENCH_LIMIT: ${{ inputs.bench_limit }}
        run: |
          echo "## Fast Reading Rate - macos" >> $GITHUB_STEP_SUMMARY
          echo "Limit: \`${{ inputs.bench_limit }}\`" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ inputs.category }}" ]; then
            echo "Category: \`${{ inputs.category }}\`" >> $GITHUB_STEP_SUMMARY
            # Run each category separately
            for CAT in $(echo "${{ inputs.category }}" | tr ',' '\n'); do
              echo "Running: $CAT" >> $GITHUB_STEP_SUMMARY
              cargo run --features tools --bin qrtool --release -- \
                reading-rate \
                --non-interactive \
                --category "$CAT" \
                --artifact-json "reading_rate_${CAT}.json" \
                2>&1 | tee "reading_rate_${CAT}.txt"
              echo "---" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "Category: all" >> $GITHUB_STEP_SUMMARY
            cargo run --features tools --bin qrtool --release -- \
              reading-rate \
              --non-interactive \
              --artifact-json "reading_rate_macos.json" \
              2>&1 | tee "reading_rate_macos.txt"
            cat "reading_rate_macos.txt" >> $GITHUB_STEP_SUMMARY
          fi
          echo '```' >> $GITHUB_STEP_SUMMARY
        shell: bash

      - name: Run Criterion smoke benchmark
        if: ${{ inputs.run_criterion_smoke }}
        env:
          QR_SMOKE: "1"
        run: |
          echo "## Criterion Smoke - macos" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cargo bench --features tools --bench real_qr_images 2>&1 | tee "criterion_smoke_macos.txt"
          cat "criterion_smoke_macos.txt" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        shell: bash

      - name: Upload fast benchmark artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fast-benchmark-results-macos
          path: |
            reading_rate_*.txt
            reading_rate_*.json
            criterion_smoke_*.txt
          retention-days: 14

  benchmark-windows:
    name: Fast Benchmark on windows
    runs-on: windows-latest
    if: ${{ inputs.platform == 'all' || inputs.platform == 'windows' }}
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-fast-bench-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-fast-bench-
            ${{ runner.os }}-cargo-bench-
            ${{ runner.os }}-cargo-

      - name: Build release (with tools)
        run: cargo build --release --features tools

      - name: Run reading rate benchmark (fast)
        if: ${{ inputs.run_reading_rate }}
        env:
          QR_BENCH_LIMIT: ${{ inputs.bench_limit }}
        run: |
          echo "## Fast Reading Rate - windows" >> $GITHUB_STEP_SUMMARY
          echo "Limit: \`${{ inputs.bench_limit }}\`" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ inputs.category }}" ]; then
            echo "Category: \`${{ inputs.category }}\`" >> $GITHUB_STEP_SUMMARY
            # Run each category separately
            for CAT in $(echo "${{ inputs.category }}" | tr ',' '\n'); do
              echo "Running: $CAT" >> $GITHUB_STEP_SUMMARY
              cargo run --features tools --bin qrtool --release -- \
                reading-rate \
                --non-interactive \
                --category "$CAT" \
                --artifact-json "reading_rate_${CAT}.json" \
                2>&1 | tee "reading_rate_${CAT}.txt"
              echo "---" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "Category: all" >> $GITHUB_STEP_SUMMARY
            cargo run --features tools --bin qrtool --release -- \
              reading-rate \
              --non-interactive \
              --artifact-json "reading_rate_windows.json" \
              2>&1 | tee "reading_rate_windows.txt"
            cat "reading_rate_windows.txt" >> $GITHUB_STEP_SUMMARY
          fi
          echo '```' >> $GITHUB_STEP_SUMMARY
        shell: bash

      - name: Run Criterion smoke benchmark
        if: ${{ inputs.run_criterion_smoke }}
        env:
          QR_SMOKE: "1"
        run: |
          echo "## Criterion Smoke - windows" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cargo bench --features tools --bench real_qr_images 2>&1 | tee "criterion_smoke_windows.txt"
          cat "criterion_smoke_windows.txt" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        shell: bash

      - name: Upload fast benchmark artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fast-benchmark-results-windows
          path: |
            reading_rate_*.txt
            reading_rate_*.json
            criterion_smoke_*.txt
          retention-days: 14
