name: Fast Benchmark

on:
  workflow_dispatch:
    inputs:
      platform:
        description: 'Target platform'
        required: false
        default: 'macos'
        type: choice
        options:
          - macos
          - linux
          - windows
          - all
      bench_limit:
        description: 'Number of images per category (0 = all)'
        required: false
        default: '25'
        type: string
      category:
        description: 'Optional category filter (e.g. rotations, blurred, high_version)'
        required: false
        default: ''
        type: string
      run_reading_rate:
        description: 'Run reading rate benchmark'
        required: false
        default: true
        type: boolean
      run_criterion_smoke:
        description: 'Run Criterion smoke benchmark'
        required: false
        default: false
        type: boolean

env:
  CARGO_TERM_COLOR: always

jobs:
  benchmark:
    name: Fast Benchmark on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    if: ${{ inputs.platform == 'all' || inputs.platform == matrix.platform }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
          - os: macos-latest
            platform: macos
          - os: windows-latest
            platform: windows

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-fast-bench-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-fast-bench-
            ${{ runner.os }}-cargo-bench-
            ${{ runner.os }}-cargo-

      - name: Build release (with tools)
        run: cargo build --release --features tools

      - name: Run reading rate benchmark (fast)
        if: ${{ inputs.run_reading_rate }}
        env:
          QR_BENCH_LIMIT: ${{ inputs.bench_limit }}
          CATEGORY_FILTER: ${{ inputs.category }}
        run: |
          CATEGORY_ARGS=()
          if [ -n "$CATEGORY_FILTER" ]; then
            CATEGORY_ARGS+=(--category "$CATEGORY_FILTER")
          fi

          echo "## Fast Reading Rate - ${{ matrix.platform }}" >> $GITHUB_STEP_SUMMARY
          echo "Limit: \`${{ inputs.bench_limit }}\`" >> $GITHUB_STEP_SUMMARY
          if [ -n "$CATEGORY_FILTER" ]; then
            echo "Category: \`$CATEGORY_FILTER\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "Category: all" >> $GITHUB_STEP_SUMMARY
          fi
          echo '```' >> $GITHUB_STEP_SUMMARY
          cargo run --features tools --bin qrtool --release -- \
            reading-rate \
            --non-interactive \
            "${CATEGORY_ARGS[@]}" \
            --artifact-json "reading_rate_${{ matrix.platform }}.json" \
            2>&1 | tee "reading_rate_${{ matrix.platform }}.txt"
          cat "reading_rate_${{ matrix.platform }}.txt" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        shell: bash

      - name: Run Criterion smoke benchmark
        if: ${{ inputs.run_criterion_smoke }}
        env:
          QR_SMOKE: "1"
        run: |
          echo "## Criterion Smoke - ${{ matrix.platform }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cargo bench --features tools --bench real_qr_images 2>&1 | tee "criterion_smoke_${{ matrix.platform }}.txt"
          cat "criterion_smoke_${{ matrix.platform }}.txt" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        shell: bash

      - name: Upload fast benchmark artifacts
        uses: actions/upload-artifact@v4
        with:
          name: fast-benchmark-results-${{ matrix.platform }}
          path: |
            reading_rate_*.txt
            reading_rate_*.json
            criterion_smoke_*.txt
          retention-days: 14
